{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 1400,
  "height": 800,
  "padding": {
    "left": 0,
    "right": 0,
    "top": 0,
    "bottom": 0
  },
  "autosize": "pad",
  "background": "#f4f7ff",
  "data": [
    {
      "name": "links",
      "url": "https://raw.githubusercontent.com/eosfor/scripting-notes/refs/heads/main/notebooks/en/vnet-topology-d3js-demo-data/linkList.json",
      "format": {
        "type": "json"
      }
    },
    {
      "name": "source-connections",
      "source": "links",
      "transform": [
        {
          "type": "aggregate",
          "groupby": [
            "source"
          ],
          "ops": [
            "values"
          ],
          "fields": [
            "target"
          ],
          "as": [
            "connections"
          ]
        },
        {
          "type": "formula",
          "as": "targets",
          "expr": "pluck(datum.connections, 'target')"
        }
      ]
    },
    {
      "name": "target-connections",
      "source": "links",
      "transform": [
        {
          "type": "aggregate",
          "groupby": [
            "target"
          ],
          "ops": [
            "values"
          ],
          "fields": [
            "source"
          ],
          "as": [
            "connections"
          ]
        },
        {
          "type": "formula",
          "as": "sources",
          "expr": "pluck(datum.connections, 'source')"
        }
      ]
    },
    {
      "name": "nodes",
      "url": "https://raw.githubusercontent.com/eosfor/scripting-notes/refs/heads/main/notebooks/en/vnet-topology-d3js-demo-data/idList.json",
      "format": {
        "type": "json"
      },
      "transform": [
        {
          "type": "lookup",
          "from": "source-connections",
          "key": "source",
          "fields": [
            "id"
          ],
          "values": [
            "targets"
          ],
          "as": [
            "targets"
          ],
          "default": [
            ""
          ]
        },
        {
          "type": "lookup",
          "from": "target-connections",
          "key": "target",
          "fields": [
            "id"
          ],
          "values": [
            "sources"
          ],
          "as": [
            "sources"
          ],
          "default": [
            ""
          ]
        },
        {
          "type": "force",
          "iterations": 300,
          "signal": "force",
          "restart": {
            "signal": "restart"
          },
          "forces": [
            {
              "force": "center",
              "x": {
                "signal": "cx"
              },
              "y": {
                "signal": "cy"
              }
            },
            {
              "force": "collide",
              "radius": {
                "signal": "sqrt(4 * nodeRadius * nodeRadius)"
              },
              "iterations": 1,
              "strength": 0.7
            },
            {
              "force": "nbody",
              "strength": {
                "signal": "nodeCharge"
              }
            },
            {
              "force": "link",
              "links": "links",
              "distance": {
                "signal": "linkDistance"
              },
              "id": "id"
            }
          ]
        },
        {
          "type": "formula",
          "as": "fx",
          "expr": "fix[0]!=null && node==datum.index ?invert('xscale',fix[0]):null"
        },
        {
          "type": "formula",
          "as": "fy",
          "expr": "fix[1]!=null && node==datum.index ?invert('yscale',fix[1]):null"
        }
      ]
    }
  ],
  "signals": [
    {
      "name": "xrange",
      "update": "[0, width]"
    },
    {
      "name": "yrange",
      "update": "[height, 0]"
    },
    {
      "name": "xext",
      "update": "[0, width]"
    },
    {
      "name": "yext",
      "update": "[height, 0]"
    },
    {
      "name": "down",
      "value": null,
      "on": [
        {
          "events": "mouseup,touchend",
          "update": "null"
        },
        {
          "events": "mousedown, touchstart",
          "update": "xy()"
        },
        {
          "events": "symbol:mousedown, symbol:touchstart",
          "update": "null"
        }
      ]
    },
    {
      "name": "xcur",
      "value": null,
      "on": [
        {
          "events": "mousedown, touchstart, touchend",
          "update": "xdom"
        }
      ]
    },
    {
      "name": "ycur",
      "value": null,
      "on": [
        {
          "events": "mousedown, touchstart, touchend",
          "update": "ydom"
        }
      ]
    },
    {
      "name": "delta",
      "value": [
        0,
        0
      ],
      "on": [
        {
          "events": [
            {
              "source": "window",
              "type": "mousemove",
              "consume": true,
              "between": [
                {
                  "type": "mousedown"
                },
                {
                  "source": "window",
                  "type": "mouseup"
                }
              ]
            },
            {
              "type": "touchmove",
              "consume": true,
              "filter": "event.touches.length === 1"
            }
          ],
          "update": "down ? [down[0]-x(), y()-down[1]] : [0,0]"
        }
      ]
    },
    {
      "name": "anchor",
      "value": [
        0,
        0
      ],
      "on": [
        {
          "events": "wheel",
          "update": "[invert('xscale', x()), invert('yscale', y())]"
        },
        {
          "events": {
            "type": "touchstart",
            "filter": "event.touches.length===2"
          },
          "update": "[(xdom[0] + xdom[1]) / 2, (ydom[0] + ydom[1]) / 2]"
        }
      ]
    },
    {
      "name": "zoom",
      "value": 1,
      "on": [
        {
          "events": "wheel!",
          "force": true,
          "update": "pow(1.001, event.deltaY * pow(16, event.deltaMode))"
        },
        {
          "events": {
            "signal": "dist2"
          },
          "force": true,
          "update": "dist1 / dist2"
        },
        {
          "events": [
            {
              "source": "view",
              "type": "dblclick"
            }
          ],
          "update": "1"
        }
      ]
    },
    {
      "name": "dist1",
      "value": 0,
      "on": [
        {
          "events": {
            "type": "touchstart",
            "filter": "event.touches.length===2"
          },
          "update": "pinchDistance(event)"
        },
        {
          "events": {
            "signal": "dist2"
          },
          "update": "dist2"
        }
      ]
    },
    {
      "name": "dist2",
      "value": 0,
      "on": [
        {
          "events": {
            "type": "touchmove",
            "consume": true,
            "filter": "event.touches.length===2"
          },
          "update": "pinchDistance(event)"
        }
      ]
    },
    {
      "name": "xdom",
      "update": "xext",
      "on": [
        {
          "events": {
            "signal": "delta"
          },
          "update": "[xcur[0] + span(xcur) * delta[0] / width, xcur[1] + span(xcur) * delta[0] / width]"
        },
        {
          "events": {
            "signal": "zoom"
          },
          "update": "[anchor[0] + (xdom[0] - anchor[0]) * zoom, anchor[0] + (xdom[1] - anchor[0]) * zoom]"
        },
        {
          "events": [
            {
              "source": "view",
              "type": "dblclick"
            }
          ],
          "update": "xrange"
        }
      ]
    },
    {
      "name": "ydom",
      "update": "yext",
      "on": [
        {
          "events": {
            "signal": "delta"
          },
          "update": "[ycur[0] + span(ycur) * delta[1] / height, ycur[1] + span(ycur) * delta[1] / height]"
        },
        {
          "events": {
            "signal": "zoom"
          },
          "update": "[anchor[1] + (ydom[0] - anchor[1]) * zoom, anchor[1] + (ydom[1] - anchor[1]) * zoom]"
        },
        {
          "events": [
            {
              "source": "view",
              "type": "dblclick"
            }
          ],
          "update": "yrange"
        }
      ]
    },
    {
      "name": "size",
      "update": "clamp(20 / span(xdom), 1, 1000)"
    },
    {
      "name": "cx",
      "update": "width / 2",
      "on": [
        {
          "events": "[symbol:mousedown, window:mouseup] > window:mousemove",
          "update": " cx==width/2?cx+0.001:width/2"
        }
      ]
    },
    {
      "name": "cy",
      "update": "height / 2"
    },
    {
      "name": "nodeRadiusKey",
      "description": "q=increase size, a=decrease size",
      "value": 8,
      "on": [
        {
          "events": "window:keypress",
          "update": "event.key=='a'&&nodeRadiusKey>1?nodeRadiusKey-1:event.key=='q'?nodeRadiusKey+1:nodeRadiusKey"
        }
      ]
    },
    {
      "name": "nodeRadius",
      "value": 8,
      "bind": {
        "input": "range",
        "min": 1,
        "max": 50,
        "step": 1
      },
      "on": [
        {
          "events": {
            "signal": "nodeRadiusKey"
          },
          "update": "nodeRadiusKey"
        }
      ]
    },
    {
      "name": "nodeCharge",
      "value": -30,
      "bind": {
        "input": "range",
        "min": -100,
        "max": 10,
        "step": 1
      }
    },
    {
      "name": "linkDistance",
      "value": 30,
      "bind": {
        "input": "range",
        "min": 5,
        "max": 300,
        "step": 1
      }
    },
    {
      "description": "State variable for active node fix status.",
      "name": "fix",
      "value": false,
      "on": [
        {
          "events": "symbol:mouseout[!event.buttons], window:mouseup",
          "update": "false"
        },
        {
          "events": "symbol:mouseover",
          "update": "fix || true",
          "force": true
        },
        {
          "events": "[symbol:mousedown, window:mouseup] > window:mousemove!",
          "update": "xy()",
          "force": true
        }
      ]
    },
    {
      "description": "Graph node most recently interacted with.",
      "name": "node",
      "value": null,
      "on": [
        {
          "events": "symbol:mouseover",
          "update": "fix === true ? datum.index : node"
        }
      ]
    },
    {
      "name": "nodeHover",
      "value": {
        "id": null,
        "connections": []
      },
      "on": [
        {
          "events": "symbol:mouseover",
          "update": "{'id':datum.index, 'connections':split(datum.sources+','+datum.targets,',')}"
        },
        {
          "events": "symbol:mouseout",
          "update": "{'id':null, 'connections':[]}"
        }
      ]
    },
    {
      "description": "Flag to restart Force simulation upon data changes.",
      "name": "restart",
      "value": false,
      "on": [
        {
          "events": {
            "signal": "fix"
          },
          "update": "fix && fix.length"
        }
      ]
    }
  ],
  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": {
        "data": "nodes",
        "field": "displayName"
      },
      "range": [
        "#4682b4",
        "#4666b4",
        "#46b494",
        "#b46746",
        "#b44662",
        "#a44fa3"
      ]
    },
    {
      "name": "xscale",
      "zero": false,
      "domain": {
        "signal": "xdom"
      },
      "range": {
        "signal": "xrange"
      }
    },
    {
      "name": "yscale",
      "zero": false,
      "domain": {
        "signal": "ydom"
      },
      "range": {
        "signal": "yrange"
      }
    }
  ],
  "marks": [
    {
      "type": "path",
      "name": "links-mark",
      "from": {
        "data": "links"
      },
      "interactive": false,
      "encode": {
        "update": {
          "stroke": {
            "signal": "datum.source.index!=nodeHover.id && datum.target.index!=nodeHover.id ? '#929399':merge(hsl(datum.color), {l:0.64})"
          },
          "strokeWidth": {
            "signal": "datum.source.index!=nodeHover.id && datum.target.index!=nodeHover.id ? 0.5:2"
          }
        }
      },
      "transform": [
        {
          "type": "linkpath",
          "require": {
            "signal": "force"
          },
          "shape": "line",
          "sourceX": {
            "expr": "scale('xscale', datum.datum.source.x)"
          },
          "sourceY": {
            "expr": "scale('yscale', datum.datum.source.y)"
          },
          "targetX": {
            "expr": "scale('xscale', datum.datum.target.x)"
          },
          "targetY": {
            "expr": "scale('yscale', datum.datum.target.y)"
          }
        }
      ]
    },
    {
      "name": "nodes-mark",
      "type": "symbol",
      "zindex": 1,
      "from": {
        "data": "nodes"
      },
      "encode": {
        "update": {
          "opacity": {
            "value": 1
          },
          "fill": {
            "signal": "nodeHover.id===datum.index || indexof(nodeHover.connections, datum.id)>-1 ? datum.color :merge(hsl(datum.color), {l:0.64})"
          },
          "stroke": {
            "signal": "nodeHover.id===datum.index || indexof(nodeHover.connections, datum.id)>-1 ? datum.color :merge(hsl(datum.color), {l:0.84})"
          },
          "strokeWidth": {
            "value": 3
          },
          "strokeOpacity": {
            "value": 1
          },
          "size": {
            "signal": "4 * nodeRadius * nodeRadius"
          },
          "cursor": {
            "value": "pointer"
          },
          "x": {
            "signal": "fix[0]!=null && node===datum.index ?fix[0]:scale('xscale', datum.x)"
          },
          "y": {
            "signal": "fix[1]!=null && node===datum.index ?fix[1]:scale('yscale', datum.y)"
          }
        },
        "hover": {
          "tooltip": {
            "signal": "datum.displayName"
          }
        }
      }
    },
    {
      "type": "group",
      "encode": {
        "update": {
          "x": {
            "signal": "width"
          },
          "y": {
            "signal": "10"
          },
          "width": {
            "value": 250
          },
          "height": {
            "value": 250
          },
          "clip": {
            "value": true
          }
        }
      },
      "data": [
        {
          "name": "group-table",
          "values": [
            {
              "color": "#ba150d",
              "name": "NIC",
              "id": 1
            },
            {
              "color": "#ff6942",
              "name": "Virtial Network",
              "id": 2
            },
            {
              "color": "#ffc500",
              "name": "Subnet",
              "id": 3
            }
          ]
        }
      ],
      "marks": [
        {
          "type": "symbol",
          "from": {"data": "group-table"},
          "name": "legend1",
          "encode": {
            "update": {
              "x": {
                "signal": "nodeRadius + 1"
              },
              "y": {
                "signal": "(2*nodeRadius + 1) * datum.id"
              },
              "size": {
                "signal": "2 * nodeRadius * nodeRadius"
              },
              "fill": {
                "signal": "datum.color"
              }
            }
          }
        },
        {
          "type": "text",
          "from": {"data": "group-table"},
          "encode": {
            "update": {
              "text": {
                "signal": "datum.name"
              },
              "align": {
                "value": "left"
              },
              "lineHeight": {
                "value": 16
              },
              "fill": {
                "value": "#595959"
              },
              "x": {
                "signal": "2 * nodeRadius + 1"
              },
              "y": {
                "signal": "(2 * nodeRadius) * datum.id + 5"
              },
              "fontSize": {
                "value": 10
              }
            }
          }
        }
      ]
    }
  ]
}